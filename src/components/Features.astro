---
import SectionBadge from './ui/SectionBadge.astro';
import FeatureCard from './ui/FeatureCard.astro';
import backgroundLettersDesktop from '../assets/background-letters-desk.svg';

// Media imports
import liveCharts from "../assets/LIVE_CHARTS.png";
import scanFilter from "../assets/SCAN_AND_FILTER.png";
import organizeTokens from "../assets/Organize_Part.mp4";
import portfolioPage from "../assets/PORTFOLIO.png";
import smartOrderRouting from "../assets/SMART_ORDER_ROUTING.png";

// Placeholder pour les icônes - vous pourrez les remplacer par vos vraies icônes
const chartIcon = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmM2YyZjIiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1jaGFydC1hcmVhLWljb24gbHVjaWRlLWNoYXJ0LWFyZWEiPjxwYXRoIGQ9Ik0zIDN2MTZhMiAyIDAgMCAwIDIgMmgxNiIvPjxwYXRoIGQ9Ik03IDExLjIwN2EuNS41IDAgMCAxIC4xNDYtLjM1M2wyLTJhLjUuNSAwIDAgMSAuNzA4IDBsMy4yOTIgMy4yOTJhLjUuNSAwIDAgMCAuNzA4IDBsNC4yOTItNC4yOTJhLjUuNSAwIDAgMSAuODU0LjM1M1YxNmExIDEgMCAwIDEtMSAxSDhhMSAxIDAgMCAxLTEtMXoiLz48L3N2Zz4=";
const filterIcon = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmM2YyZjIiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1saXN0LWZpbHRlci1wbHVzLWljb24gbHVjaWRlLWxpc3QtZmlsdGVyLXBsdXMiPjxwYXRoIGQ9Ik0xMCAxOGg0Ii8+PHBhdGggZD0iTTExIDZIMyIvPjxwYXRoIGQ9Ik0xNSA2aDYiLz48cGF0aCBkPSJNMTggOVYzIi8+PHBhdGggZD0iTTcgMTJoOCIvPjwvc3ZnPg==";
const organizeIcon = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmM2YyZjIiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1mb2xkZXItdHJlZS1pY29uIGx1Y2lkZS1mb2xkZXItdHJlZSI+PHBhdGggZD0iTTIwIDEwYTEgMSAwIDAgMCAxLTFWNmExIDEgMCAwIDAtMS0xaC0yLjVhMSAxIDAgMCAxLS44LS40bC0uOS0xLjJBMSAxIDAgMCAwIDE1IDNoLTJhMSAxIDAgMCAwLTEgMXY1YTEgMSAwIDAgMCAxIDFaIi8+PHBhdGggZD0iTTIwIDIxYTEgMSAwIDAgMCAxLTF2LTNhMSAxIDAgMCAwLTEtMWgtMi45YTEgMSAwIDAgMS0uODgtLjU1bC0uNDItLjg1YTEgMSAwIDAgMC0uOTItLjZIMTNhMSAxIDAgMCAwLTEgMXY1YTEgMSAwIDAgMCAxIDFaIi8+PHBhdGggZD0iTTMgNWEyIDIgMCAwIDAgMiAyaDMiLz48cGF0aCBkPSJNMyAzdjEzYTIgMiAwIDAgMCAyIDJoMyIvPjwvc3ZnPg==";
const portfolioIcon = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmM2YyZjIiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS13YWxsZXQtbWluaW1hbC1pY29uIGx1Y2lkZS13YWxsZXQtbWluaW1hbCI+PHBhdGggZD0iTTE3IDE0aC4wMSIvPjxwYXRoIGQ9Ik03IDdoMTJhMiAyIDAgMCAxIDIgMnYxMGEyIDIgMCAwIDEtMiAySDVhMiAyIDAgMCAxLTItMlY1YTIgMiAwIDAgMSAyLTJoMTQiLz48L3N2Zz4=";
const routingIcon = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmM2YyZjIiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1nYXVnZS1pY29uIGx1Y2lkZS1nYXVnZSI+PHBhdGggZD0ibTEyIDE0IDQtNCIvPjxwYXRoIGQ9Ik0zLjM0IDE5YTEwIDEwIDAgMSAxIDE3LjMyIDAiLz48L3N2Zz4=";
---

<section id="features" class="relative py-20 md:py-32 px-4 sm:px-6 lg:px-8 bg-primary-dark overflow-hidden">
  <!-- Background effects -->
  <div class="absolute inset-0">
    <!-- Pattern background -->
    <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[2151px] h-[1429px]">
      <img 
        src={backgroundLettersDesktop.src} 
        alt="" 
        class="w-full h-full object-cover"
      />
    </div>
    
    <!-- Effets de lueur -->
    <div class="absolute -left-[386px] -top-[932px] w-[2692px] h-[1644px] bg-primary-blue opacity-5 blur-[200px]"></div>
    <div class="absolute left-1/2 -top-[256px] transform -translate-x-1/2 w-[944px] h-[944px] bg-secondary-blue opacity-10 blur-[150px]"></div>
  </div>

  <div class="relative z-10 max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="flex flex-col items-center text-center mb-12 md:mb-20">
      <!-- Section Badge -->
      <SectionBadge text="Features" />
      
      <!-- Titre principal -->
      <h2 class="text-white font-bold text-2xl md:text-4xl lg:text-5xl leading-tight mb-4 max-w-2xl mx-auto">
        Everything you need.<br/>
        Nothing you don't.
      </h2>
      
      <!-- Sous-titre -->
      <p class="text-light-blue font-medium text-base md:text-lg leading-relaxed max-w-md mx-auto tracking-tight">
        Fast execution, clear data, and powerful tools — without the noise.
      </p>
    </div>

    <!-- Features Grid -->
    <div class="lg:grid lg:grid-cols-2 lg:gap-8 lg:items-start">
      <div class="max-w-md mx-auto md:max-w-2xl lg:max-w-none">
        <!-- Ligne de séparation -->
        <div class="w-full h-px bg-gradient-to-r from-transparent via-white/20 to-transparent mb-5"></div>
        
        <div class="flex flex-col gap-5" id="features-list">
          <!-- Feature 1 - Expanded by default on desktop -->
          <FeatureCard 
            icon={chartIcon}
            title="Live charts, always on"
            description="See your trades evolve in real time. No refreshes. No lag. Just raw market data, updating live."
            media={{ type: 'image', src: liveCharts.src }}
            isExpanded={true}
          />
          
          <!-- Feature 2 -->
          <FeatureCard 
            icon={filterIcon}
            title="Scan & filter trending tokens"
            description="Never miss a move. Quickly spot tokens on the rise and filter by volume, trend, or market cap."
            media={{ type: 'image', src: scanFilter.src }}
          />
          
          <!-- Feature 4 -->
          <FeatureCard 
            icon={organizeIcon}
            title="Organize your tokens"
            description="Stay on top of your investments. Sort, track, and manage your assets all from one dashboard."
            media={{ type: 'video', src: organizeTokens }}
          />
          
          <!-- Feature 5 -->
          <FeatureCard 
            icon={portfolioIcon}
            title="A complete portfolio page"
            description="Your portfolio at a glance. See performance, allocation, and history in a clear, intuitive view."
            media={{ type: 'image', src: portfolioPage.src }}
          />
          
          <!-- Feature 6 -->
          <FeatureCard 
            icon={routingIcon}
            title="Ultra-fast smart order routing"
            description="Lightning-fast execution, optimal prices. Our tech routes every trade for the best available price, instantly."
            media={{ type: 'image', src: smartOrderRouting.src }}
          />
        </div>
        
        <!-- Ligne de séparation finale -->
        <div class="w-full h-px bg-gradient-to-r from-transparent via-white/20 to-transparent mt-5"></div>
      </div>

      <!-- Right side - Video/GIF display for desktop -->
      <div class="hidden lg:block sticky top-28">
        <div class="relative aspect-square bg-secondary-blue rounded-[10px] overflow-hidden">
           <div class="absolute inset-0 bg-gradient-dark rounded-[10px]"></div>
          <img id="feature-image-display" 
               src={liveCharts.src} 
               alt="Feature preview" 
               width="500" 
               height="500"
               class="absolute inset-0 w-full h-full object-cover transition-opacity duration-300 will-change-opacity"
               style="transform: translateZ(0);">
          <video id="feature-video-display"
                 autoplay loop muted playsinline
                 class="absolute inset-0 w-full h-full object-cover transition-opacity duration-300 will-change-opacity opacity-0"
                 style="transform: translateZ(0);"></video>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
    if (window.innerWidth < 1024) return; // lg breakpoint

    const featuresList = document.getElementById('features-list');
    if (!featuresList) return;
    
    const featureCards = featuresList.querySelectorAll('.feature-card-wrapper');
    const imageDisplay = document.getElementById('feature-image-display') as HTMLImageElement | null;
    const videoDisplay = document.getElementById('feature-video-display') as HTMLVideoElement | null;
    if (!imageDisplay || !videoDisplay) return;

    function updateMediaDisplay(activeCard: Element) {
        const mediaSrc = (activeCard as HTMLElement).dataset.mediaSrc;
        const mediaType = (activeCard as HTMLElement).dataset.mediaType;

        if (!mediaSrc || !mediaType) return;

        const isImage = mediaType === 'image';
        
        // Fade out both elements first
        imageDisplay.style.opacity = '0';
        videoDisplay.style.opacity = '0';
        
        setTimeout(() => {
            if (isImage) {
                if (imageDisplay.src !== mediaSrc) {
                    imageDisplay.src = mediaSrc;
                }
                imageDisplay.style.opacity = '1';
                videoDisplay.pause();
                videoDisplay.currentTime = 0;
            } else {
                if (videoDisplay.src !== mediaSrc) {
                    videoDisplay.src = mediaSrc;
                }
                videoDisplay.style.opacity = '1';
                videoDisplay.play();
            }
        }, 150); // Match this with transition duration
    }

    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-expanded') {
                const card = mutation.target as Element;
                const isExpanded = card.getAttribute('data-expanded') === 'true';
                
                if (isExpanded) {
                    updateMediaDisplay(card);
                }
            }
        });
    });

    featureCards.forEach(card => {
        observer.observe(card, { attributes: true, attributeFilter: ['data-expanded'] });
        
        // Initialiser l'image pour la carte déjà expandée
        if (card.getAttribute('data-expanded') === 'true') {
            updateMediaDisplay(card);
        }
    });

    // Cleanup lors du déchargement
    window.addEventListener('beforeunload', () => {
        observer.disconnect();
    });
});
</script>